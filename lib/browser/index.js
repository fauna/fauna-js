var H=(n,e,r)=>{if(!e.has(n))throw TypeError("Cannot "+r)};var C=(n,e,r)=>(H(n,e,"read from private field"),r?r.call(n):e.get(n)),F=(n,e,r)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,r)},P=(n,e,r,t)=>(H(n,e,"write to private field"),t?t.call(n,r):e.set(n,r),r);var _=(n,e,r)=>(H(n,e,"access private method"),r);var j={cloud:new URL("https://db.fauna.com"),preview:new URL("https://db.fauna-preview.com"),local:new URL("http://localhost:8443"),localhost:new URL("http://localhost:8443")};var U=n=>n instanceof Object&&"data"in n,L=n=>n instanceof Object&&"error"in n&&n.error instanceof Object&&"code"in n.error&&"message"in n.error;var o=class extends Error{httpStatus;code;summary;constructor(e,r){super(e.error.message),Error.captureStackTrace&&Error.captureStackTrace(this,o),this.name="ServiceError",this.code=e.error.code,this.httpStatus=r,e.summary&&(this.summary=e.summary)}},m=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,m),this.name="QueryRuntimeError"}},f=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,f),this.name="QueryCheckError"}},h=class extends o{stats;constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,h),this.name="QueryTimeoutError",this.stats=e.stats}},T=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,T),this.name="AuthenticationError"}},b=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,b),this.name="AuthorizationError"}},x=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,x),this.name="ThrottlingError"}},S=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,S),this.name="ServiceInternalError"}},Q=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,Q),this.name="ServiceTimeoutError"}},l=class extends Error{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,l),this.name="ClientError"}},c=class extends Error{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,c),this.name="NetworkError"}},y=class extends Error{httpStatus;constructor(e){super(e.message),Error.captureStackTrace&&Error.captureStackTrace(this,y),this.name="ProtocolError",this.httpStatus=e.httpStatus}};var q=class{async request({data:e,headers:r,method:t,url:s}){let a=await fetch(s,{method:t,headers:{...r,"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(g=>{throw new c("The network connection encountered a problem.",{cause:g})}),i=a.status,u={};a.headers.forEach((g,R)=>u[R]=g);let d=await a.text();return{status:i,body:d,headers:u}}};var D=()=>new q,V=n=>n instanceof Object&&"body"in n&&"headers"in n&&"status"in n;var E=class{static encode(e){return new A(e).result}static decode(e){return JSON.parse(e,(r,t)=>t==null?null:t["@mod"]?t["@mod"]:t["@doc"]?t["@doc"]:t["@int"]?Number(t["@int"]):t["@long"]?BigInt(t["@long"]):t["@double"]?Number(t["@double"]):t["@date"]?new Date(t["@date"]+"T00:00:00.000Z"):t["@time"]?new Date(t["@time"]):t["@object"]?t["@object"]:t)}},M=BigInt("-9223372036854775808"),z=BigInt("9223372036854775807"),A=class{result;#e={bigint:e=>{if(e<M||e>z)throw new TypeError("Precision loss when converting BigInt to Fauna type");return{"@long":e.toString()}},number:e=>{if(e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY)throw new TypeError(`Cannot convert ${e} to a Fauna type`);return`${e}`.includes(".")?{"@double":e.toString()}:e>=-(2**31)&&e<=2**31-1?{"@int":e.toString()}:Number.isSafeInteger(e)?{"@long":e.toString()}:{"@double":e.toString()}},string:e=>e,object:e=>{let r=!1,t={};for(let s in e)s.startsWith("@")&&(r=!0),t[s]=E.encode(e[s]);return r?{"@object":t}:t},array:e=>{let r=[];for(let t in e)r.push(E.encode(e[t]));return r},date:e=>e.getUTCHours()==0&&e.getUTCMinutes()==0&&e.getUTCSeconds()==0&&e.getUTCMilliseconds()==0?{"@date":e.toISOString().split("T")[0]}:{"@time":e.toISOString()}};constructor(e){switch(this.result=e,typeof e){case"bigint":this.result=this.#e.bigint(e);break;case"string":this.result=this.#e.string(e);break;case"number":this.result=this.#e.number(e);break;case"object":e==null?this.result=null:Array.isArray(e)?this.result=this.#e.array(e):e instanceof Date?this.result=this.#e.date(e):this.result=this.#e.object(e);break}}};var G={endpoint:j.cloud,max_conns:10},I=class{#e;#t;#r;#n;constructor(e,r){this.#e={...G,...e,secret:this.#i(e)},this.#n=`${this.clientConfiguration.endpoint.toString()}query/1`,r?this.#t=r:this.#t=D()}get lastTxnTs(){return this.#r}set lastTxnTs(e){if(this.lastTxnTs!==void 0&&e<this.lastTxnTs)throw new Error("Must be greater than current value");this.#r=e}get clientConfiguration(){let{secret:e,...r}=this.#e;return r}async query(e,r){return"query"in e?this.#o({...e,...r}):this.#o(e.toQuery(r))}#s(e){if(e instanceof l||e instanceof c||e instanceof y||e instanceof o)return e;if(V(e)){if(L(e.body)){let r=e.body,t=e.status;return this.#a(r,t)}return new y({message:`Response is in an unkown format: ${e.body}`,httpStatus:e.status})}return new l("A client level error occurred. Fauna was not called.",{cause:e})}#i(e){let r;typeof process=="object"&&(r=process.env.FAUNA_SECRET);let t=e?.secret||r;if(t===void 0)throw new Error("You must provide a secret to the driver. Set it in an environmental variable named FAUNA_SECRET or pass it to the Client constructor.");return t}#a(e,r){switch(r){case 400:return r===400&&Y.includes(e.error.code)?new f(e,r):new m(e,r);case 401:return new T(e,r);case 403:return new b(e,r);case 429:return new x(e,r);case 440:return new h(e,r);case 500:return new S(e,r);case 503:return new Q(e,r);default:return new o(e,r)}}async#o(e){try{let r={Authorization:`Bearer ${this.#e.secret}`,"x-typecheck":"false"};this.#u({...this.clientConfiguration,...e},r);let t=(this.#e.format??"tagged")==="tagged"||e.format==="tagged",s=t?E.encode(e.arguments):e.arguments,a={query:e.query,arguments:s},i=await this.#t.request({url:this.#n,method:"POST",headers:r,data:a}),u;try{u={...i,body:t?E.decode(i.body):JSON.parse(i.body)}}catch(g){throw new y({message:`Error parsing response as JSON: ${g}`,httpStatus:i.status})}if(!U(u.body))throw this.#s(u);let d=u.body.txn_ts;return(this.#r===void 0&&d!==void 0||d!==void 0&&this.#r!==void 0&&this.#r<d)&&(this.#r=d),u.body}catch(r){throw this.#s(r)}}#u(e,r){for(let t of Object.entries(e))if(["format","last_txn_ts","query_timeout_ms","linearized","max_contention_retries","traceparent","query_tags"].includes(t[0])){let s,a=`x-${t[0].replaceAll("_","-")}`;t[0]==="query_tags"?s=Object.entries(t[1]).map(i=>i.join("=")).join(","):t[0]==="last_txn_ts"||typeof t[1]=="string"?s=t[1]:s=String(t[1]),t[0]==="traceparent"&&(a=t[0]),r[a]=s}r["x-last-txn-ts"]===void 0&&this.#r!==void 0&&(r["x-last-txn-ts"]=this.#r)}},Y=["invalid_function_definition","invalid_identifier","invalid_query","invalid_syntax","invalid_type"];function K(n,...e){return N.create(n,...e)}var p,k,J,O,$,w=class{constructor(e){F(this,O);F(this,p,void 0);var r;if("queryFragments"in e){if(e.queryFragments.length===0||e.queryFragments.length!==e.queryArgs.length+1)throw new Error("invalid query constructed");P(this,p,{...e,queryArgs:_(r=w,k,J).call(r,e.queryArgs)})}else P(this,p,e)}static create(e,...r){var t;return new w({queryFragments:e,queryArgs:_(t=w,k,J).call(t,r)})}toQuery(e={},r=0){return{..._(this,O,$).call(this,r),...e}}},N=w;p=new WeakMap,k=new WeakSet,J=function(e){return e.map(r=>typeof r?.toQuery=="function"?r:new w({json:r}))},O=new WeakSet,$=function(e=0){if("queryFragments"in C(this,p)){let{queryFragments:r,queryArgs:t}=C(this,p),s=r[0];if(s===void 0)throw new Error("Internal error!");let a=[s],i={};return t.forEach((u,d)=>{let{query:g,arguments:R}=u.toQuery({},e);R!==void 0&&(e+=Object.keys(R).length);let B=r[d+1];if(B===void 0)throw new Error("Internal error!");a.push(g,B),i={...i,...R}}),{query:a.join(""),arguments:i}}else{let r=`arg${e}`,t={};return t[r]=C(this,p).json,{query:`${r}`,arguments:t}}},F(N,k);export{T as AuthenticationError,b as AuthorizationError,I as Client,l as ClientError,c as NetworkError,y as ProtocolError,f as QueryCheckError,m as QueryRuntimeError,h as QueryTimeoutError,o as ServiceError,S as ServiceInternalError,Q as ServiceTimeoutError,x as ThrottlingError,j as endpoints,K as fql};
//# sourceMappingURL=index.js.map
