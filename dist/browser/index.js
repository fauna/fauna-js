var P={cloud:new URL("https://db.fauna.com"),preview:new URL("https://db.fauna-preview.com"),local:new URL("http://localhost:8443"),localhost:new URL("http://localhost:8443")};var q=class extends Error{constructor(...e){super(...e)}},i=class extends q{httpStatus;code;summary;constraint_failures;constructor(e,r){super(e.error.message),Error.captureStackTrace&&Error.captureStackTrace(this,i),this.name="ServiceError",this.code=e.error.code,this.httpStatus=r,e.summary&&(this.summary=e.summary),e.error.constraint_failures!==void 0&&(this.constraint_failures=e.error.constraint_failures)}},h=class extends i{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,h),this.name="QueryRuntimeError"}},T=class extends i{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,T),this.name="QueryCheckError"}},b=class extends i{stats;constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,b),this.name="QueryTimeoutError",this.stats=e.stats}},S=class extends i{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,S),this.name="AuthenticationError"}},x=class extends i{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,x),this.name="AuthorizationError"}},w=class extends i{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,w),this.name="ThrottlingError"}},Q=class extends i{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,Q),this.name="ServiceInternalError"}},E=class extends i{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,E),this.name="ServiceTimeoutError"}},l=class extends q{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,l),this.name="ClientError"}},m=class extends q{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,m),this.name="NetworkError"}},p=class extends q{httpStatus;constructor(e){super(e.message),Error.captureStackTrace&&Error.captureStackTrace(this,p),this.name="ProtocolError",this.httpStatus=e.httpStatus}};var V=t=>t instanceof Object&&"data"in t,M=t=>t instanceof Object&&"error"in t&&t.error instanceof Object&&"code"in t.error&&"message"in t.error;var C=class{async request({data:e,headers:r,method:n,url:s}){let o=await fetch(s,{method:n,headers:{...r,"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(f=>{throw new m("The network connection encountered a problem.",{cause:f})}),a=o.status,c={};o.headers.forEach((f,D)=>c[D]=f);let d=await o.text();return{status:a,body:d,headers:c}}};var L=()=>new C,B=t=>t instanceof Object&&"body"in t&&"headers"in t&&"status"in t;var Y=/(?:\d{4}|[\u2212-]\d{4,}|\+\d{5,})/,Z=/(?:0[1-9]|1[0-2])/,K=/(?:0[1-9]|[12]\d|3[01])/,U=/(?:[01][0-9]|2[0-3])/,k=/(?:[0-5][0-9])/,X=/(?:\.\d+)/,I=new RegExp(`(${Y.source}-(${Z.source})-(${K.source}))`),v=new RegExp(`(${U.source}:${k.source}:${k.source}${X.source}?)`),ee=new RegExp(`([zZ]|[+\u2212-]${U.source}(?::?${k.source}|:${k.source}:${k.source}))`),z=new RegExp(`^${I.source}$`),G=new RegExp(`^${I.source}`),W=new RegExp(`^${I.source}T${v.source}${ee.source}$`);var y=class{isoString;constructor(e){this.isoString=e}static from(e){if(typeof e!="string")throw new TypeError(`Expected string but received ${typeof e}: ${e}`);if(W.exec(e)===null)throw new RangeError(`(regex) Expected an ISO date string but received '${e}'`);return new y(e)}static fromDate(e){return new y(e.toISOString())}toDate(){let e=new Date(this.isoString);if(e.toString()==="Invalid Date")throw new RangeError("Fauna Date could not be converted to Javascript Date");return e}toString(){return`TimeStub("${this.isoString}")`}},g=class{dateString;constructor(e){this.dateString=e}static from(e){if(typeof e!="string")throw new TypeError(`Expected string but received ${typeof e}: ${e}`);let r=z.exec(e);if(r===null)throw new RangeError(`Expected a plain date string but received '${e}'`);return new g(r[0])}static fromDate(e){let r=e.toISOString(),n=G.exec(r);if(n===null)throw new l(`Failed to parse date '${e}'`);return new g(n[0])}toDate(){let e=new Date(this.dateString+"T00:00:00Z");if(e.toString()==="Invalid Date")throw new RangeError("Fauna Date could not be converted to Javascript Date");return e}toString(){return`DateStub("${this.dateString}")`}};var R=class{coll;id;constructor({coll:e,id:r}){this.id=r,typeof e=="string"?this.coll=new O(e):this.coll=e}},_=class extends R{ts;constructor(e){let{coll:r,id:n,ts:s,...o}=e;super({coll:r,id:n}),this.ts=s,Object.assign(this,o)}toObject(){return{...this}}},F=class{coll;name;constructor({coll:e,name:r}){this.name=r,typeof e=="string"?this.coll=new O(e):this.coll=e}},j=class extends F{ts;data;constructor(e){let{coll:r,name:n,ts:s,data:o,...a}=e;super({coll:r,name:n}),this.ts=s,this.data=o||{},Object.assign(this,a)}toObject(){return{...this}}},O=class{name;constructor(e){this.name=e}};var J=class{data;after;constructor({data:e,after:r}){this.data=e,this.after=r}};var N=class{static encode(e){return $(e)}static decode(e){return JSON.parse(e,(r,n)=>{if(n==null)return null;if(n["@mod"])return new O(n["@mod"]);if(n["@doc"]){if(typeof n["@doc"]=="string"){let[o,a]=n["@doc"].split(":");return new R({coll:o,id:a})}let s=n["@doc"];return s.id?new _(s):new j(s)}else if(n["@ref"]){let s=n["@ref"];return s.id?new R(s):new F(s)}else{if(n["@set"])return new J(n["@set"]);if(n["@int"])return Number(n["@int"]);if(n["@long"])return BigInt(n["@long"]);if(n["@double"])return Number(n["@double"]);if(n["@date"])return g.from(n["@date"]);if(n["@time"])return y.from(n["@time"]);if(n["@object"])return n["@object"]}return n})}},re=BigInt("-9223372036854775808"),ne=BigInt("9223372036854775807"),u={bigint:t=>{if(t<re||t>ne)throw new RangeError("Precision loss when converting BigInt to Fauna type");return{"@long":t.toString()}},number:t=>{if(t===Number.POSITIVE_INFINITY||t===Number.NEGATIVE_INFINITY)throw new RangeError(`Cannot convert ${t} to a Fauna type.`);return`${t}`.includes(".")?{"@double":t.toString()}:t>=-(2**31)&&t<=2**31-1?{"@int":t.toString()}:Number.isSafeInteger(t)?{"@long":t.toString()}:{"@double":t.toString()}},string:t=>t,object:t=>{let e=!1,r={};for(let n in t)n.startsWith("@")&&(e=!0),r[n]=$(t[n]);return e?{"@object":r}:r},array:t=>{let e=[];for(let r in t)e.push($(t[r]));return e},date:t=>({"@time":t.toISOString()}),faunadate:t=>({"@date":t.dateString}),faunatime:t=>({"@time":t.isoString}),module:t=>({"@mod":t.name}),documentReference:t=>({"@ref":{id:t.id,coll:{"@mod":t.coll.name}}}),document:t=>({"@ref":{id:t.id,coll:{"@mod":t.coll.name}}}),namedDocumentReference:t=>({"@ref":{name:t.name,coll:{"@mod":t.coll.name}}}),namedDocument:t=>({"@ref":{name:t.name,coll:{"@mod":t.coll.name}}}),set:t=>({"@set":{data:u.array(t.data),after:t.after}})},$=t=>{switch(typeof t){case"bigint":return u.bigint(t);case"string":return u.string(t);case"number":return u.number(t);case"object":return t==null?null:Array.isArray(t)?u.array(t):t instanceof Date?u.date(t):t instanceof g?u.faunadate(t):t instanceof y?u.faunatime(t):t instanceof O?u.module(t):t instanceof R?u.documentReference(t):t instanceof _?u.document(t):t instanceof F?u.namedDocumentReference(t):t instanceof j?u.namedDocument(t):t instanceof J?u.set(t):u.object(t)}return t};var se={endpoint:P.cloud,max_conns:10},H=class{#t;#r;#e;#n;constructor(e,r){this.#t={...se,...e,secret:this.#a(e)},this.#n=`${this.clientConfiguration.endpoint.toString()}query/1`,r?this.#r=r:this.#r=L()}get lastTxnTs(){return this.#e}set lastTxnTs(e){this.#e=this.#e?Math.max(e,this.#e):e}get clientConfiguration(){let{secret:e,...r}=this.#t;return r}async query(e,r){return"query"in e?this.#o({...e,...r}):this.#o(e.toQuery(r))}#s(e){if(e instanceof l||e instanceof m||e instanceof p||e instanceof i)return e;if(B(e)){if(M(e.body)){let r=e.body,n=e.status;return this.#i(r,n)}return new p({message:`Response is in an unkown format: ${e.body}`,httpStatus:e.status})}return new l("A client level error occurred. Fauna was not called.",{cause:e})}#a(e){let r;typeof process=="object"&&(r=process.env.FAUNA_SECRET);let n=e?.secret||r;if(n===void 0)throw new Error("You must provide a secret to the driver. Set it in an environmental variable named FAUNA_SECRET or pass it to the Client constructor.");return n}#i(e,r){switch(r){case 400:return r===400&&oe.includes(e.error.code)?new T(e,r):new h(e,r);case 401:return new S(e,r);case 403:return new x(e,r);case 429:return new w(e,r);case 440:return new b(e,r);case 500:return new Q(e,r);case 503:return new E(e,r);default:return new i(e,r)}}async#o(e){try{let r={Authorization:`Bearer ${this.#t.secret}`};this.#c({...this.clientConfiguration,...e},r);let n=(this.#t.format??"tagged")==="tagged"||e.format==="tagged",s=n?N.encode(e.arguments):e.arguments,o={query:e.query,arguments:s},a=await this.#r.request({url:this.#n,method:"POST",headers:r,data:o}),c;try{if(c={...a,body:n?N.decode(a.body):JSON.parse(a.body)},c.body.query_tags){let f=c.body.query_tags.split(",").map(D=>D.split("="));c.body.query_tags=Object.fromEntries(f)}}catch(f){throw new p({message:`Error parsing response as JSON: ${f}`,httpStatus:a.status})}if(!V(c.body))throw this.#s(c);let d=c.body.txn_ts;return(this.#e===void 0&&d!==void 0||d!==void 0&&this.#e!==void 0&&this.#e<d)&&(this.#e=d),c.body}catch(r){throw this.#s(r)}}#c(e,r){for(let n of Object.entries(e))if(["format","query_timeout_ms","linearized","max_contention_retries","traceparent","typecheck","query_tags"].includes(n[0])){let s,o=`x-${n[0].replaceAll("_","-")}`;n[0]==="query_tags"?s=Object.entries(n[1]).map(a=>a.join("=")).join(","):typeof n[1]=="string"?s=n[1]:s=String(n[1]),n[0]==="traceparent"&&(o=n[0]),r[o]=s}r["x-last-txn-ts"]===void 0&&this.#e!==void 0&&(r["x-last-txn-ts"]=this.#e)}},oe=["invalid_function_definition","invalid_identifier","invalid_query","invalid_syntax","invalid_type"];var ae=t=>t instanceof Object&&typeof t.toQuery=="function";function ie(t,...e){return new A(t,...e)}var A=class{#t;#r;constructor(e,...r){if(e.length===0||e.length!==r.length+1)throw new Error("invalid query constructed");this.#t=e,this.#r=r}toQuery(e={}){return{...this.#e(e),...e}}#e(e){if(this.#t.length===1)return{query:{fql:[this.#t[0]]},arguments:{}};let r={};return{query:{fql:this.#t.flatMap((s,o)=>{if(o===this.#t.length-1)return s===""?[]:[s];let a=this.#r[o],c;if(ae(a)){let d=a.toQuery(e);c=d.query,r={...r,...d.arguments}}else c={value:N.encode(a)};return[s,c].filter(d=>d!=="")})},arguments:r}}};export{S as AuthenticationError,x as AuthorizationError,H as Client,l as ClientError,m as NetworkError,p as ProtocolError,T as QueryCheckError,h as QueryRuntimeError,b as QueryTimeoutError,i as ServiceError,Q as ServiceInternalError,E as ServiceTimeoutError,w as ThrottlingError,P as endpoints,ie as fql};
//# sourceMappingURL=index.js.map
