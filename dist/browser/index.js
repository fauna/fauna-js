var C={cloud:new URL("https://db.fauna.com"),preview:new URL("https://db.fauna-preview.com"),local:new URL("http://localhost:8443"),localhost:new URL("http://localhost:8443")};var O=class extends Error{constructor(...e){super(...e)}},s=class extends O{httpStatus;code;summary;constraint_failures;constructor(e,r){super(e.error.message),Error.captureStackTrace&&Error.captureStackTrace(this,s),this.name="ServiceError",this.code=e.error.code,this.httpStatus=r,e.summary&&(this.summary=e.summary),e.error.constraint_failures!==void 0&&(this.constraint_failures=e.error.constraint_failures)}},h=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,h),this.name="QueryRuntimeError"}},b=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,b),this.name="QueryCheckError"}},T=class extends s{stats;constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,T),this.name="QueryTimeoutError",this.stats=e.stats}},S=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,S),this.name="AuthenticationError"}},x=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,x),this.name="AuthorizationError"}},Q=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,Q),this.name="ThrottlingError"}},E=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,E),this.name="ServiceInternalError"}},w=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,w),this.name="ServiceTimeoutError"}},p=class extends O{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,p),this.name="ClientError"}},y=class extends O{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,y),this.name="NetworkError"}},d=class extends O{httpStatus;constructor(e){super(e.message),Error.captureStackTrace&&Error.captureStackTrace(this,d),this.name="ProtocolError",this.httpStatus=e.httpStatus}};var $=t=>t instanceof Object&&"data"in t,J=t=>t instanceof Object&&"error"in t&&t.error instanceof Object&&"code"in t.error&&"message"in t.error;var q=class{async request({data:e,headers:r,method:n,url:i}){let a=await fetch(i,{method:n,headers:{...r,"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(f=>{throw new y("The network connection encountered a problem.",{cause:f})}),c=a.status,o={};a.headers.forEach((f,F)=>o[F]=f);let u=await a.text();return{status:c,body:u,headers:o}}};var D=()=>new q,H=t=>t instanceof Object&&"body"in t&&"headers"in t&&"status"in t;var B=/(?:\d{4}|[\u2212-]\d{4,}|\+\d{5,})/,U=/(?:0[1-9]|1[0-2])/,M=/(?:0[1-9]|[12]\d|3[01])/,j=/(?:[01][0-9]|2[0-3])/,N=/(?:[0-5][0-9])/,z=/(?:\.\d+)/,k=new RegExp(`(${B.source}-(${U.source})-(${M.source}))`),v=new RegExp(`(${j.source}:${N.source}:${N.source}${z.source}?)`),G=new RegExp(`([zZ]|[+\u2212-]${j.source}(?::?${N.source}|:${N.source}:${N.source}))`),A=new RegExp(`^${k.source}$`),V=new RegExp(`^${k.source}`),L=new RegExp(`^${k.source}T${v.source}${G.source}$`);var l=class{isoString;constructor(e){this.isoString=e}static from(e){if(typeof e!="string")throw new TypeError(`Expected string but received ${typeof e}: ${e}`);if(L.exec(e)===null)throw new RangeError(`(regex) Expected an ISO date string but received '${e}'`);return new l(e)}static fromDate(e){return new l(e.toISOString())}toDate(){let e=new Date(this.isoString);if(e.toString()==="Invalid Date")throw new RangeError("Fauna Date could not be converted to Javascript Date");return e}toString(){return`TimeStub("${this.isoString}")`}},g=class{dateString;constructor(e){this.dateString=e}static from(e){if(typeof e!="string")throw new TypeError(`Expected string but received ${typeof e}: ${e}`);let r=A.exec(e);if(r===null)throw new RangeError(`Expected a plain date string but received '${e}'`);return new g(r[0])}static fromDate(e){let r=e.toISOString(),n=V.exec(r);if(n===null)throw new p(`Failed to parse date '${e}'`);return new g(n[0])}toDate(){let e=new Date(this.dateString+"T00:00:00Z");if(e.toString()==="Invalid Date")throw new RangeError("Fauna Date could not be converted to Javascript Date");return e}toString(){return`DateStub("${this.dateString}")`}};var R=class{static encode(e){return _(e)}static decode(e){return JSON.parse(e,(r,n)=>{if(n==null)return null;if(n["@mod"])return n["@mod"];if(n["@doc"]){if(typeof n["@doc"]=="string"){let[i,a]=n["@doc"].split(":");return{coll:i,id:a}}return n["@doc"]}else{if(n["@ref"])return n["@ref"];if(n["@set"])return n["@set"];if(n["@int"])return Number(n["@int"]);if(n["@long"])return BigInt(n["@long"]);if(n["@double"])return Number(n["@double"]);if(n["@date"])return g.from(n["@date"]);if(n["@time"])return l.from(n["@time"]);if(n["@object"])return n["@object"]}return n})}},Y=BigInt("-9223372036854775808"),Z=BigInt("9223372036854775807"),m={bigint:t=>{if(t<Y||t>Z)throw new RangeError("Precision loss when converting BigInt to Fauna type");return{"@long":t.toString()}},number:t=>{if(t===Number.POSITIVE_INFINITY||t===Number.NEGATIVE_INFINITY)throw new RangeError(`Cannot convert ${t} to a Fauna type.`);return`${t}`.includes(".")?{"@double":t.toString()}:t>=-(2**31)&&t<=2**31-1?{"@int":t.toString()}:Number.isSafeInteger(t)?{"@long":t.toString()}:{"@double":t.toString()}},string:t=>t,object:t=>{let e=!1,r={};for(let n in t)n.startsWith("@")&&(e=!0),r[n]=_(t[n]);return e?{"@object":r}:r},array:t=>{let e=[];for(let r in t)e.push(_(t[r]));return e},date:t=>({"@time":t.toISOString()}),faunadate:t=>({"@date":t.dateString}),faunatime:t=>({"@time":t.isoString})},_=t=>{switch(typeof t){case"bigint":return m.bigint(t);case"string":return m.string(t);case"number":return m.number(t);case"object":return t==null?null:Array.isArray(t)?m.array(t):t instanceof Date?m.date(t):t instanceof g?m.faunadate(t):t instanceof l?m.faunatime(t):m.object(t)}return t};var K={endpoint:C.cloud,max_conns:10},P=class{#r;#t;#e;#n;constructor(e,r){this.#r={...K,...e,secret:this.#i(e)},this.#n=`${this.clientConfiguration.endpoint.toString()}query/1`,r?this.#t=r:this.#t=D()}get lastTxnTs(){return this.#e}set lastTxnTs(e){this.#e=this.#e?Math.max(e,this.#e):e}get clientConfiguration(){let{secret:e,...r}=this.#r;return r}async query(e,r){return"query"in e?this.#o({...e,...r}):this.#o(e.toQuery(r))}#s(e){if(e instanceof p||e instanceof y||e instanceof d||e instanceof s)return e;if(H(e)){if(J(e.body)){let r=e.body,n=e.status;return this.#a(r,n)}return new d({message:`Response is in an unkown format: ${e.body}`,httpStatus:e.status})}return new p("A client level error occurred. Fauna was not called.",{cause:e})}#i(e){let r;typeof process=="object"&&(r=process.env.FAUNA_SECRET);let n=e?.secret||r;if(n===void 0)throw new Error("You must provide a secret to the driver. Set it in an environmental variable named FAUNA_SECRET or pass it to the Client constructor.");return n}#a(e,r){switch(r){case 400:return r===400&&X.includes(e.error.code)?new b(e,r):new h(e,r);case 401:return new S(e,r);case 403:return new x(e,r);case 429:return new Q(e,r);case 440:return new T(e,r);case 500:return new E(e,r);case 503:return new w(e,r);default:return new s(e,r)}}async#o(e){try{let r={Authorization:`Bearer ${this.#r.secret}`};this.#c({...this.clientConfiguration,...e},r);let n=(this.#r.format??"tagged")==="tagged"||e.format==="tagged",i=n?R.encode(e.arguments):e.arguments,a={query:e.query,arguments:i},c=await this.#t.request({url:this.#n,method:"POST",headers:r,data:a}),o;try{if(o={...c,body:n?R.decode(c.body):JSON.parse(c.body)},o.body.query_tags){let f=o.body.query_tags.split(",").map(F=>F.split("="));o.body.query_tags=Object.fromEntries(f)}}catch(f){throw new d({message:`Error parsing response as JSON: ${f}`,httpStatus:c.status})}if(!$(o.body))throw this.#s(o);let u=o.body.txn_ts;return(this.#e===void 0&&u!==void 0||u!==void 0&&this.#e!==void 0&&this.#e<u)&&(this.#e=u),o.body}catch(r){throw this.#s(r)}}#c(e,r){for(let n of Object.entries(e))if(["format","query_timeout_ms","linearized","max_contention_retries","traceparent","typecheck","query_tags"].includes(n[0])){let i,a=`x-${n[0].replaceAll("_","-")}`;n[0]==="query_tags"?i=Object.entries(n[1]).map(c=>c.join("=")).join(","):typeof n[1]=="string"?i=n[1]:i=String(n[1]),n[0]==="traceparent"&&(a=n[0]),r[a]=i}r["x-last-txn-ts"]===void 0&&this.#e!==void 0&&(r["x-last-txn-ts"]=this.#e)}},X=["invalid_function_definition","invalid_identifier","invalid_query","invalid_syntax","invalid_type"];var ee=t=>t instanceof Object&&typeof t.toQuery=="function";function re(t,...e){return new I(t,...e)}var I=class{#r;#t;constructor(e,...r){if(e.length===0||e.length!==r.length+1)throw new Error("invalid query constructed");this.#r=e,this.#t=r}toQuery(e={}){return{...this.#e(e),...e}}#e(e){if(this.#r.length===1)return{query:{fql:[this.#r[0]]},arguments:{}};let r={};return{query:{fql:this.#r.flatMap((i,a)=>{if(a===this.#r.length-1)return i===""?[]:[i];let c=this.#t[a],o;if(ee(c)){let u=c.toQuery(e);o=u.query,r={...r,...u.arguments}}else o={value:R.encode(c)};return[i,o].filter(u=>u!=="")})},arguments:r}}};export{S as AuthenticationError,x as AuthorizationError,P as Client,p as ClientError,y as NetworkError,d as ProtocolError,b as QueryCheckError,h as QueryRuntimeError,T as QueryTimeoutError,s as ServiceError,E as ServiceInternalError,w as ServiceTimeoutError,Q as ThrottlingError,C as endpoints,re as fql};
//# sourceMappingURL=index.js.map
