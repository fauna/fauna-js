var P=(n,e,r)=>{if(!e.has(n))throw TypeError("Cannot "+r)};var q=(n,e,r)=>(P(n,e,"read from private field"),r?r.call(n):e.get(n)),F=(n,e,r)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,r)},_=(n,e,r,t)=>(P(n,e,"write to private field"),t?t.call(n,r):e.set(n,r),r);var N=(n,e,r)=>(P(n,e,"access private method"),r);var j={cloud:new URL("https://db.fauna.com"),preview:new URL("https://db.fauna-preview.com"),local:new URL("http://localhost:8443"),localhost:new URL("http://localhost:8443")};var B=n=>n instanceof Object&&"data"in n,U=n=>n instanceof Object&&"error"in n&&n.error instanceof Object&&"code"in n.error&&"message"in n.error;var s=class extends Error{httpStatus;code;summary;constructor(e,r){super(e.error.message),Error.captureStackTrace&&Error.captureStackTrace(this,s),this.name="ServiceError",this.code=e.error.code,this.httpStatus=r,e.summary&&(this.summary=e.summary)}},f=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,f),this.name="QueryRuntimeError"}},h=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,h),this.name="QueryCheckError"}},T=class extends s{stats;constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,T),this.name="QueryTimeoutError",this.stats=e.stats}},b=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,b),this.name="AuthenticationError"}},S=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,S),this.name="AuthorizationError"}},x=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,x),this.name="ThrottlingError"}},Q=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,Q),this.name="ServiceInternalError"}},E=class extends s{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,E),this.name="ServiceTimeoutError"}},g=class extends Error{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,g),this.name="ClientError"}},c=class extends Error{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,c),this.name="NetworkError"}},y=class extends Error{httpStatus;constructor(e){super(e.message),Error.captureStackTrace&&Error.captureStackTrace(this,y),this.name="ProtocolError",this.httpStatus=e.httpStatus}};var k=class{async request({data:e,headers:r,method:t,url:o}){let i=await fetch(o,{method:t,headers:{...r,"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(d=>{throw new c("The network connection encountered a problem.",{cause:d})}),a=i.status,u={};i.headers.forEach((d,m)=>u[m]=d);let l=await i.text();return{status:a,body:l,headers:u}}};var L=()=>new k,V=n=>n instanceof Object&&"body"in n&&"headers"in n&&"status"in n;var w=class{static encode(e){return new A(e).result}static decode(e){return JSON.parse(e,(r,t)=>t==null?null:t["@mod"]?t["@mod"]:t["@doc"]?t["@doc"]:t["@int"]?Number(t["@int"]):t["@long"]?BigInt(t["@long"]):t["@double"]?Number(t["@double"]):t["@date"]?new Date(t["@date"]+"T00:00:00.000Z"):t["@time"]?new Date(t["@time"]):t["@object"]?t["@object"]:t)}},M=BigInt("-9223372036854775808"),z=BigInt("9223372036854775807"),A=class{result;#e={bigint:e=>{if(e<M||e>z)throw new TypeError("Precision loss when converting BigInt to Fauna type");return{"@long":e.toString()}},number:e=>{if(e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY)throw new TypeError(`Cannot convert ${e} to a Fauna type`);return`${e}`.includes(".")?{"@double":e.toString()}:e>=-(2**31)&&e<=2**31-1?{"@int":e.toString()}:Number.isSafeInteger(e)?{"@long":e.toString()}:{"@double":e.toString()}},string:e=>e,object:e=>{let r=!1,t={};for(let o in e)o.startsWith("@")&&(r=!0),t[o]=w.encode(e[o]);return r?{"@object":t}:t},array:e=>{let r=[];for(let t in e)r.push(w.encode(e[t]));return r},date:e=>e.getUTCHours()==0&&e.getUTCMinutes()==0&&e.getUTCSeconds()==0&&e.getUTCMilliseconds()==0?{"@date":e.toISOString().split("T")[0]}:{"@time":e.toISOString()}};constructor(e){switch(this.result=e,typeof e){case"bigint":this.result=this.#e.bigint(e);break;case"string":this.result=this.#e.string(e);break;case"number":this.result=this.#e.number(e);break;case"object":e==null?this.result=null:Array.isArray(e)?this.result=this.#e.array(e):e instanceof Date?this.result=this.#e.date(e):this.result=this.#e.object(e);break}}};var G={endpoint:j.cloud,max_conns:10},I=class{#e;#t;#r;#n;constructor(e,r){this.#e={...G,...e,secret:this.#i(e)},this.#n=`${this.clientConfiguration.endpoint.toString()}query/1`,r?this.#t=r:this.#t=L()}get lastTxnTime(){return this.#r}set lastTxnTime(e){if(this.lastTxnTime!==void 0&&e.getTime()<this.lastTxnTime.getTime())throw new Error("Must be greater than current value");this.#r=e}get clientConfiguration(){let{secret:e,...r}=this.#e;return r}async query(e,r){return"query"in e?this.#o({...e,...r}):this.#o(e.toQuery(r))}#s(e){if(e instanceof g||e instanceof c||e instanceof y||e instanceof s)return e;if(V(e)){if(U(e.body)){let r=e.body,t=e.status;return this.#a(r,t)}return new y({message:`Response is in an unkown format: ${e.body}`,httpStatus:e.status})}return new g("A client level error occurred. Fauna was not called.",{cause:e})}#i(e){let r;typeof process=="object"&&(r=process.env.FAUNA_SECRET);let t=e?.secret||r;if(t===void 0)throw new Error("You must provide a secret to the driver. Set it in an environmental variable named FAUNA_SECRET or pass it to the Client constructor.");return t}#a(e,r){switch(r){case 400:return r===400&&Y.includes(e.error.code)?new h(e,r):new f(e,r);case 401:return new b(e,r);case 403:return new S(e,r);case 429:return new x(e,r);case 440:return new T(e,r);case 500:return new Q(e,r);case 503:return new E(e,r);default:return new s(e,r)}}async#o(e){try{let r={Authorization:`Bearer ${this.#e.secret}`,"x-typecheck":"false"};this.#u({...this.clientConfiguration,...e},r);let t=(this.#e.format??"tagged")==="tagged"||e.format==="tagged",o=t?w.encode(e.arguments):e.arguments,i={query:e.query,arguments:o},a=await this.#t.request({url:this.#n,method:"POST",headers:r,data:i}),u;try{u={...a,body:t?w.decode(a.body):JSON.parse(a.body)}}catch(m){throw new y({message:`Error parsing response as JSON: ${m}`,httpStatus:a.status})}if(!B(u.body))throw this.#s(u);let l=u.body.txn_time,d=new Date(l);return(this.#r===void 0&&l!==void 0||l!==void 0&&this.#r!==void 0&&this.#r<d)&&(this.#r=d),u.body}catch(r){throw this.#s(r)}}#u(e,r){for(let t of Object.entries(e))if(["format","last_txn","timeout_ms","linearized","max_contention_retries","traceparent","tags"].includes(t[0])){let o,i=`x-${t[0].replaceAll("_","-")}`;t[0]==="tags"?(i="x-fauna-tags",o=Object.entries(t[1]).map(a=>a.join("=")).join(",")):typeof t[1]=="string"?o=t[1]:o=String(t[1]),t[0]==="traceparent"&&(i=t[0]),r[i]=o}r["x-last-txn"]===void 0&&this.#r!==void 0&&(r["x-last-txn"]=this.#r.toISOString())}},Y=["invalid_function_definition","invalid_identifier","invalid_query","invalid_syntax","invalid_type"];function K(n,...e){return O.create(n,...e)}var p,C,J,H,$,R=class{constructor(e){F(this,H);F(this,p,void 0);var r;if("queryFragments"in e){if(e.queryFragments.length===0||e.queryFragments.length!==e.queryArgs.length+1)throw new Error("invalid query constructed");_(this,p,{...e,queryArgs:N(r=R,C,J).call(r,e.queryArgs)})}else _(this,p,e)}static create(e,...r){var t;return new R({queryFragments:e,queryArgs:N(t=R,C,J).call(t,r)})}toQuery(e={},r=0){return{...N(this,H,$).call(this,r),...e}}},O=R;p=new WeakMap,C=new WeakSet,J=function(e){return e.map(r=>typeof r?.toQuery=="function"?r:new R({json:r}))},H=new WeakSet,$=function(e=0){if("queryFragments"in q(this,p)){let{queryFragments:r,queryArgs:t}=q(this,p),o=r[0];if(o===void 0)throw new Error("Internal error!");let i=[o],a={};return t.forEach((u,l)=>{let{query:d,arguments:m}=u.toQuery({},e);m!==void 0&&(e+=Object.keys(m).length);let D=r[l+1];if(D===void 0)throw new Error("Internal error!");i.push(d,D),a={...a,...m}}),{query:i.join(""),arguments:a}}else{let r=`arg${e}`,t={};return t[r]=q(this,p).json,{query:`${r}`,arguments:t}}},F(O,C);export{b as AuthenticationError,S as AuthorizationError,I as Client,g as ClientError,c as NetworkError,y as ProtocolError,h as QueryCheckError,f as QueryRuntimeError,T as QueryTimeoutError,s as ServiceError,Q as ServiceInternalError,E as ServiceTimeoutError,x as ThrottlingError,j as endpoints,K as fql};
//# sourceMappingURL=index.js.map
