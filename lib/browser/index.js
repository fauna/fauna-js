var P=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var k=(t,e,r)=>(P(t,e,"read from private field"),r?r.call(t):e.get(t)),C=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},N=(t,e,r,n)=>(P(t,e,"write to private field"),n?n.call(t,r):e.set(t,r),r);var H=(t,e,r)=>(P(t,e,"access private method"),r);var v={cloud:new URL("https://db.fauna.com"),preview:new URL("https://db.fauna-preview.com"),local:new URL("http://localhost:8443"),localhost:new URL("http://localhost:8443")};var j=t=>t instanceof Object&&"data"in t,B=t=>t instanceof Object&&"error"in t&&t.error instanceof Object&&"code"in t.error&&"message"in t.error;var o=class extends Error{httpStatus;code;summary;constructor(e,r){super(e.error.message),Error.captureStackTrace&&Error.captureStackTrace(this,o),this.name="ServiceError",this.code=e.error.code,this.httpStatus=r,e.summary&&(this.summary=e.summary)}},d=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,d),this.name="QueryRuntimeError"}},m=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,m),this.name="QueryCheckError"}},g=class extends o{stats;constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,g),this.name="QueryTimeoutError",this.stats=e.stats}},h=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,h),this.name="AuthenticationError"}},f=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,f),this.name="AuthorizationError"}},T=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,T),this.name="ThrottlingError"}},x=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,x),this.name="ServiceInternalError"}},Q=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,Q),this.name="ServiceTimeoutError"}},y=class extends Error{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,y),this.name="ClientError"}},u=class extends Error{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,u),this.name="NetworkError"}},c=class extends Error{httpStatus;constructor(e){super(e.message),Error.captureStackTrace&&Error.captureStackTrace(this,c),this.name="ProtocolError",this.httpStatus=e.httpStatus}};var w=class{async request({data:e,headers:r,method:n,url:i}){let s=await fetch(i,{method:n,headers:{...r,"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(b=>{throw new u("The network connection encountered a problem.",{cause:b})}),a=s.status,l={};s.headers.forEach((b,R)=>l[R]=b);let E=await s.text();return{status:a,body:E,headers:l}}};var U=()=>new w,V=t=>t instanceof Object&&"body"in t&&"headers"in t&&"status"in t;var D={max_conns:10,endpoint:v.cloud,timeout_ms:6e4},_=class{#r;#t;#e;#n;constructor(e,r){this.#r={...D,...e,secret:this.#i(e)},this.#n=`${this.clientConfiguration.endpoint.toString()}query/1`,r?this.#t=r:this.#t=U()}get lastTxnTime(){return this.#e}set lastTxnTime(e){if(this.lastTxnTime!==void 0&&e.getTime()<this.lastTxnTime.getTime())throw new Error("Must be greater than current value");this.#e=e}get clientConfiguration(){let{secret:e,...r}=this.#r;return r}async query(e,r){return"query"in e?this.#o({...e,...r}):this.#o(e.toQuery(r))}#s(e){if(e instanceof y||e instanceof u||e instanceof c||e instanceof o)return e;if(V(e)){if(B(e.body)){let r=e.body,n=e.status;return this.#a(r,n)}return new c({message:`Response is in an unkown format: ${e.body}`,httpStatus:e.status})}return new y("A client level error occurred. Fauna was not called.",{cause:e})}#i(e){let r;typeof process=="object"&&(r=process.env.FAUNA_SECRET);let n=e?.secret||r;if(n===void 0)throw new Error("You must provide a secret to the driver. Set it in an environmental variable named FAUNA_SECRET or pass it to the Client constructor.");return n}#a(e,r){switch(r){case 400:return r===400&&$.includes(e.error.code)?new m(e,r):new d(e,r);case 401:return new h(e,r);case 403:return new f(e,r);case 429:return new T(e,r);case 440:return new g(e,r);case 500:return new x(e,r);case 503:return new Q(e,r);default:return new o(e,r)}}async#o(e){try{let r={Authorization:`Bearer ${this.#r.secret}`,"x-typecheck":"false","x-format":"simple"};this.#u({...this.clientConfiguration,...e},r);let n={query:e.query,arguments:e.arguments},i=await this.#t.request({url:this.#n,method:"POST",headers:r,data:n}),s;try{s={...i,body:JSON.parse(i.body)}}catch(E){throw new c({message:`Error parsing response as JSON: ${E}`,httpStatus:i.status})}if(!j(s.body))throw this.#s(s);let a=s.body.txn_time,l=new Date(a);return(this.#e===void 0&&a!==void 0||a!==void 0&&this.#e!==void 0&&this.#e<l)&&(this.#e=l),s.body}catch(r){throw this.#s(r)}}#u(e,r){for(let n of Object.entries(e))if(["last_txn","timeout_ms","linearized","max_contention_retries","traceparent","tags"].includes(n[0])){let i,s=`x-${n[0].replaceAll("_","-")}`;n[0]==="tags"?(s="x-fauna-tags",i=Object.entries(n[1]).map(a=>a.join("=")).join(",")):typeof n[1]=="string"?i=n[1]:i=String(n[1]),n[0]==="traceparent"&&(s=n[0]),r[s]=i}r["x-last-txn"]===void 0&&this.#e!==void 0&&(r["x-last-txn"]=this.#e.toISOString())}},$=["invalid_function_definition","invalid_identifier","invalid_query","invalid_syntax","invalid_type"];function z(t,...e){return F.create(t,...e)}var p,q,A,O,L,S=class{constructor(e){C(this,O);C(this,p,void 0);var r;if("queryFragments"in e){if(e.queryFragments.length===0||e.queryFragments.length!==e.queryArgs.length+1)throw new Error("invalid query constructed");N(this,p,{...e,queryArgs:H(r=S,q,A).call(r,e.queryArgs)})}else N(this,p,e)}static create(e,...r){var n;return new S({queryFragments:e,queryArgs:H(n=S,q,A).call(n,r)})}toQuery(e={},r=0){return{...H(this,O,L).call(this,r),...e}}},F=S;p=new WeakMap,q=new WeakSet,A=function(e){return e.map(r=>typeof r?.toQuery=="function"?r:new S({json:r}))},O=new WeakSet,L=function(e=0){if("queryFragments"in k(this,p)){let{queryFragments:r,queryArgs:n}=k(this,p),i=r[0];if(i===void 0)throw new Error("Internal error!");let s=[i],a={};return n.forEach((l,E)=>{let{query:b,arguments:R}=l.toQuery({},e);R!==void 0&&(e+=Object.keys(R).length);let J=r[E+1];if(J===void 0)throw new Error("Internal error!");s.push(b,J),a={...a,...R}}),{query:s.join(""),arguments:a}}else{let r=`arg${e}`,n={};return n[r]=k(this,p).json,{query:`${r}`,arguments:n}}},C(F,q);export{h as AuthenticationError,f as AuthorizationError,_ as Client,y as ClientError,u as NetworkError,c as ProtocolError,m as QueryCheckError,d as QueryRuntimeError,g as QueryTimeoutError,o as ServiceError,x as ServiceInternalError,Q as ServiceTimeoutError,T as ThrottlingError,v as endpoints,z as fql};
//# sourceMappingURL=index.js.map
