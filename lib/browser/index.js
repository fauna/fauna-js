var R={cloud:new URL("https://db.fauna.com"),preview:new URL("https://db.fauna-preview.com"),local:new URL("http://localhost:8443"),localhost:new URL("http://localhost:8443")};var o=class extends Error{httpStatus;code;summary;constructor(e,r){super(e.error.message),Error.captureStackTrace&&Error.captureStackTrace(this,o),this.name="ServiceError",this.code=e.error.code,this.httpStatus=r,e.summary&&(this.summary=e.summary)}},g=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,g),this.name="QueryRuntimeError"}},m=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,m),this.name="QueryCheckError"}},f=class extends o{stats;constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,f),this.name="QueryTimeoutError",this.stats=e.stats}},h=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,h),this.name="AuthenticationError"}},T=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,T),this.name="AuthorizationError"}},b=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,b),this.name="ThrottlingError"}},x=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,x),this.name="ServiceInternalError"}},Q=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,Q),this.name="ServiceTimeoutError"}},d=class extends Error{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,d),this.name="ClientError"}},y=class extends Error{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,y),this.name="NetworkError"}},p=class extends Error{httpStatus;constructor(e){super(e.message),Error.captureStackTrace&&Error.captureStackTrace(this,p),this.name="ProtocolError",this.httpStatus=e.httpStatus}};var k=n=>n instanceof Object&&"data"in n,_=n=>n instanceof Object&&"error"in n&&n.error instanceof Object&&"code"in n.error&&"message"in n.error;var E=class{async request({data:e,headers:r,method:t,url:s}){let u=await fetch(s,{method:t,headers:{...r,"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(S=>{throw new y("The network connection encountered a problem.",{cause:S})}),i=u.status,a={};u.headers.forEach((S,N)=>a[N]=S);let c=await u.text();return{status:i,body:c,headers:a}}};var F=()=>new E,O=n=>n instanceof Object&&"body"in n&&"headers"in n&&"status"in n;var l=class{static encode(e){return new w(e).result}static decode(e){return JSON.parse(e,(r,t)=>t==null?null:t["@mod"]?t["@mod"]:t["@doc"]?t["@doc"]:t["@int"]?Number(t["@int"]):t["@long"]?BigInt(t["@long"]):t["@double"]?Number(t["@double"]):t["@date"]?new Date(t["@date"]+"T00:00:00.000Z"):t["@time"]?new Date(t["@time"]):t["@object"]?t["@object"]:t)}},H=BigInt("-9223372036854775808"),P=BigInt("9223372036854775807"),w=class{result;#e={bigint:e=>{if(e<H||e>P)throw new RangeError("Precision loss when converting BigInt to Fauna type");return{"@long":e.toString()}},number:e=>{if(e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY)throw new RangeError(`Cannot convert ${e} to a Fauna type.`);return`${e}`.includes(".")?{"@double":e.toString()}:e>=-(2**31)&&e<=2**31-1?{"@int":e.toString()}:Number.isSafeInteger(e)?{"@long":e.toString()}:{"@double":e.toString()}},string:e=>e,object:e=>{let r=!1,t={};for(let s in e)s.startsWith("@")&&(r=!0),t[s]=l.encode(e[s]);return r?{"@object":t}:t},array:e=>{let r=[];for(let t in e)r.push(l.encode(e[t]));return r},date:e=>e.getUTCHours()==0&&e.getUTCMinutes()==0&&e.getUTCSeconds()==0&&e.getUTCMilliseconds()==0?{"@date":e.toISOString().split("T")[0]}:{"@time":e.toISOString()}};constructor(e){switch(this.result=e,typeof e){case"bigint":this.result=this.#e.bigint(e);break;case"string":this.result=this.#e.string(e);break;case"number":this.result=this.#e.number(e);break;case"object":e==null?this.result=null:Array.isArray(e)?this.result=this.#e.array(e):e instanceof Date?this.result=this.#e.date(e):this.result=this.#e.object(e);break}}};var I={endpoint:R.cloud,max_conns:10},q=class{#e;#t;#r;#n;constructor(e,r){this.#e={...I,...e,secret:this.#i(e)},this.#n=`${this.clientConfiguration.endpoint.toString()}query/1`,r?this.#t=r:this.#t=F()}get lastTxnTs(){return this.#r}set lastTxnTs(e){if(this.lastTxnTs!==void 0&&e<this.lastTxnTs)throw new Error("Must be greater than current value");this.#r=e}get clientConfiguration(){let{secret:e,...r}=this.#e;return r}async query(e,r){return"query"in e?this.#o({...e,...r}):this.#o(e.toQuery(r))}#s(e){if(e instanceof d||e instanceof y||e instanceof p||e instanceof o)return e;if(O(e)){if(_(e.body)){let r=e.body,t=e.status;return this.#a(r,t)}return new p({message:`Response is in an unkown format: ${e.body}`,httpStatus:e.status})}return new d("A client level error occurred. Fauna was not called.",{cause:e})}#i(e){let r;typeof process=="object"&&(r=process.env.FAUNA_SECRET);let t=e?.secret||r;if(t===void 0)throw new Error("You must provide a secret to the driver. Set it in an environmental variable named FAUNA_SECRET or pass it to the Client constructor.");return t}#a(e,r){switch(r){case 400:return r===400&&j.includes(e.error.code)?new m(e,r):new g(e,r);case 401:return new h(e,r);case 403:return new T(e,r);case 429:return new b(e,r);case 440:return new f(e,r);case 500:return new x(e,r);case 503:return new Q(e,r);default:return new o(e,r)}}async#o(e){try{let r={Authorization:`Bearer ${this.#e.secret}`,"x-typecheck":"false"};this.#u({...this.clientConfiguration,...e},r);let t=(this.#e.format??"tagged")==="tagged"||e.format==="tagged",s=t?l.encode(e.arguments):e.arguments,u={query:e.query,arguments:s},i=await this.#t.request({url:this.#n,method:"POST",headers:r,data:u}),a;try{a={...i,body:t?l.decode(i.body):JSON.parse(i.body)}}catch(S){throw new p({message:`Error parsing response as JSON: ${S}`,httpStatus:i.status})}if(!k(a.body))throw this.#s(a);let c=a.body.txn_ts;return(this.#r===void 0&&c!==void 0||c!==void 0&&this.#r!==void 0&&this.#r<c)&&(this.#r=c),a.body}catch(r){throw this.#s(r)}}#u(e,r){for(let t of Object.entries(e))if(["format","last_txn_ts","query_timeout_ms","linearized","max_contention_retries","traceparent","query_tags"].includes(t[0])){let s,u=`x-${t[0].replaceAll("_","-")}`;t[0]==="query_tags"?s=Object.entries(t[1]).map(i=>i.join("=")).join(","):t[0]==="last_txn_ts"||typeof t[1]=="string"?s=t[1]:s=String(t[1]),t[0]==="traceparent"&&(u=t[0]),r[u]=s}r["x-last-txn-ts"]===void 0&&this.#r!==void 0&&(r["x-last-txn-ts"]=this.#r)}},j=["invalid_function_definition","invalid_identifier","invalid_query","invalid_syntax","invalid_type"];var A=n=>n instanceof Object&&typeof n.toQuery=="function";function J(n,...e){return new C(n,...e)}var C=class{#e;#t;constructor(e,...r){if(e.length===0||e.length!==r.length+1)throw new Error("invalid query constructed");this.#e=e,this.#t=r}toQuery(e={}){return{...this.#r(e),...e}}#r(e){if(this.#e.length===1)return{query:{fql:[this.#e[0]]},arguments:{}};let r={};return{query:{fql:this.#e.flatMap((s,u)=>{if(u===this.#e.length-1)return s===""?[]:[s];let i=this.#t[u],a;if(A(i)){let c=i.toQuery(e);a=c.query,r={...r,...c.arguments}}else a={value:l.encode(i)};return[s,a].filter(c=>c!=="")})},arguments:r}}};export{h as AuthenticationError,T as AuthorizationError,q as Client,d as ClientError,y as NetworkError,p as ProtocolError,m as QueryCheckError,g as QueryRuntimeError,f as QueryTimeoutError,o as ServiceError,x as ServiceInternalError,Q as ServiceTimeoutError,b as ThrottlingError,R as endpoints,J as fql};
//# sourceMappingURL=index.js.map
